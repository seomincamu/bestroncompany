<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë² ìŠ¤íŠ¸ë¡  ìƒë‹´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap');
* {
font-family: 'Noto Sans KR', sans-serif;
}

body {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
min-height: 100vh;
}

.login-bg {
background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(https://cdn.pixabay.com/photo/2016/11/23/15/23/cosmos-1853491_1280.jpg);
background-size: cover;
background-position: center;
min-height: 100vh;
}

.glass-card {
background: rgba(255, 255, 255, 0.98);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.2);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.status-badge {
transition: all 0.3s ease;
}

.status-badge:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.table-row {
transition: all 0.3s ease;
}

.table-row:hover {
background: rgba(0, 0, 0, 0.05);
}

.btn-primary {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
transition: all 0.3s ease;
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.btn-success {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
transition: all 0.3s ease;
}

.btn-success:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-info {
background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
transition: all 0.3s ease;
}

.btn-info:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.modal-overlay {
background: rgba(0, 0, 0, 0.7);
backdrop-filter: blur(5px);
}

.animate-fade-in {
animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.status-waiting { background: #fbbf24; color: #fbbf24; }
.status-first-call { background: #dbeafe; color: #1e40af; }
.status-in-progress { background: #f97316; color: #f97316; }
.status-approved { background: #ec4899; color: #ec4899; }
.status-absent { background: #374151; color: #374151; }
.status-rejected { background: #ef4444; color: #ef4444; }
.status-as { background: #8b5cf6; color: #8b5cf6; }
.status-recontact { background: #a16207; color: #a16207; }

.category-tab {
transition: all 0.3s ease;
cursor: pointer;
}

.category-tab.active {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
}

.category-tab:not(.active):hover {
background: rgba(0, 0, 0, 0.1);
}

.logo-text {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.checkbox-custom {
width: 16px;
height: 16px;
accent-color: #000000;
}

.editable-field {
cursor: pointer;
padding: 1px 4px;
border-radius: 3px;
transition: all 0.3s ease;
}

.editable-field:hover {
background: rgba(0, 0, 0, 0.05);
color: #2563eb;
}

.compact-table {
table-layout: fixed;
width: 100%;
border-collapse: collapse;
}

.compact-table th {
padding: 6px 2px;
font-size: 12px;
text-align: center;
border-right: 1px solid #e5e7eb;
}

.compact-table td {
padding: 5px 2px;
font-size: 13px;
text-align: center;
border-right: 1px solid #e5e7eb;
}

.compact-table th:first-child,
.compact-table td:first-child {
width: 4%;
}

.compact-table th:nth-child(2),
.compact-table td:nth-child(2) {
width: 6%;
}

.compact-table th:nth-child(3),
.compact-table td:nth-child(3) {
width: 8%;
}

.compact-table th:nth-child(4),
.compact-table td:nth-child(4) {
width: 10%;
}

.compact-table th:nth-child(5),
.compact-table td:nth-child(5) {
width: 8%;
}

.compact-table th:nth-child(6),
.compact-table td:nth-child(6) {
width: 12%;
}

.compact-table th:nth-child(7),
.compact-table td:nth-child(7) {
width: 8%;
}

.compact-table th:nth-child(8),
.compact-table td:nth-child(8) {
width: 12%;
}

.compact-table th:nth-child(9),
.compact-table td:nth-child(9) {
width: 12%;
}

.compact-table th:nth-child(10),
.compact-table td:nth-child(10) {
width: 8%;
}

.compact-table th:nth-child(11),
.compact-table td:nth-child(11) {
width: 12%;
}

.status-select, .manager-select {
background: transparent;
border: none;
outline: none;
cursor: pointer;
appearance: none;
-webkit-appearance: none;
-moz-appearance: none;
text-align: center;
width: 100%;
font-size: 12px;
}

.status-select:focus, .manager-select:focus {
outline: 2px solid #3b82f6;
outline-offset: 1px;
}

.compact-btn {
padding: 6px 10px;
font-size: 12px;
}

.data-backup-section {
background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
border: 2px dashed #9ca3af;
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
text-align: center;
}

.backup-btn {
background: linear-gradient(135deg, #059669 0%, #047857 100%);
color: white;
padding: 8px 16px;
border-radius: 8px;
font-weight: 600;
margin: 0 5px;
transition: all 0.3s ease;
}

.backup-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
}

.restore-btn {
background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
color: white;
padding: 8px 16px;
border-radius: 8px;
font-weight: 600;
margin: 0 5px;
transition: all 0.3s ease;
}

.restore-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}
</style>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen" class="login-bg flex items-center justify-center">
<div class="glass-card rounded-2xl p-8 w-full max-w-md">
<div class="text-center mb-8">
<h1 class="text-4xl font-bold logo-text mb-2">ë² ìŠ¤íŠ¸ë¡ </h1>
<p class="text-gray-600">ìƒë‹´ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
</div>

<form onsubmit="handleLogin(event)">
<div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">ì•„ì´ë””</label>
    <input type="text" id="loginId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
</div>
<div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
</div>
<button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-lg font-semibold">ë¡œê·¸ì¸</button>
</form>
</div>
</div>

<!-- Main Application -->
<div id="mainApp" class="hidden">
<div class="container mx-auto px-4 py-6">
<!-- Header -->
<div class="glass-card rounded-2xl p-5 mb-5 animate-fade-in">
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 mb-1">ë² ìŠ¤íŠ¸ë¡ </h1>
        <p class="text-sm text-gray-600">ìƒë‹´ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </div>
    <div class="flex space-x-2">
        <!-- Registration Button -->
        <button onclick="toggleRegistration()" class="flex items-center space-x-2 btn-success text-white compact-btn rounded-lg font-medium">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            <span>ìƒë‹´ë“±ë¡</span>
        </button>

        <!-- Data Management Button -->
        <button onclick="toggleDataManagement()" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white compact-btn rounded-lg font-medium transition-all">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 1.79 4 4 4h8c2.21 0 4-1.79 4-4V7M4 7h16M4 7l1-4h14l1 4M10 11v6M14 11v6"></path>
            </svg>
            <span>ë°ì´í„°ê´€ë¦¬</span>
        </button>

        <!-- Batch Status Change Button -->
        <button onclick="openBatchStatusModal()" class="flex items-center space-x-2 btn-info text-white compact-btn rounded-lg font-medium opacity-50 cursor-not-allowed" id="batchStatusBtn" disabled>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <span>ì²´í¬ëª©ë¡ ìƒíƒœë³€ê²½</span>
        </button>

        <!-- Batch Delete Button -->
        <button onclick="openBatchDeleteModal()" class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white compact-btn rounded-lg font-medium transition-all opacity-50 cursor-not-allowed" id="batchDeleteBtn" disabled>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span>ì²´í¬ëª©ë¡ ì‚­ì œ</span>
        </button>

        <!-- Logout Button -->
        <button onclick="logout()" class="flex items-center space-x-2 text-red-600 hover:text-red-800 compact-btn border border-red-600 rounded-lg font-medium transition-colors">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            <span>ë¡œê·¸ì•„ì›ƒ</span>
        </button>
    </div>
</div>
</div>

<!-- Data Management Modal -->
<div id="dataManagementModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-2xl w-full mx-4">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-900">ë°ì´í„° ê´€ë¦¬</h3>
        <button onclick="closeDataManagement()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div class="data-backup-section">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">ğŸ”’ ë°ì´í„° ì˜êµ¬ ë³´ì¡´ ì‹œìŠ¤í…œ</h4>
        <p class="text-sm text-gray-600 mb-4">
            ìƒˆë¡œê³ ì¹¨ì´ë‚˜ ì¬ë¡œê·¸ì¸ ì‹œì—ë„ ëª¨ë“  ë°ì´í„°ê°€ ë³´ì¡´ë©ë‹ˆë‹¤.<br>
            ì •ê¸°ì ì¸ ë°±ì—…ì„ í†µí•´ ë”ìš± ì•ˆì „í•˜ê²Œ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.
        </p>
        
        <div class="flex flex-wrap justify-center gap-3 mb-4">
            <button onclick="downloadBackup()" class="backup-btn">
                ğŸ“¥ ë°ì´í„° ë°±ì—… ë‹¤ìš´ë¡œë“œ
            </button>
            <button onclick="document.getElementById('restore-file').click()" class="restore-btn">
                ğŸ“¤ ë°±ì—… íŒŒì¼ ë³µì›
            </button>
            <button onclick="manualSave()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all">
                ğŸ’¾ ìˆ˜ë™ ì €ì¥
            </button>
            <button onclick="clearAllData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all">
                ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ
            </button>
        </div>

        <input id="restore-file" type="file" accept=".json" class="hidden" onchange="restoreFromFile(event)">
        
        <div class="text-xs text-gray-500 space-y-1">
            <p>ğŸ’¡ <strong>ìë™ ì €ì¥:</strong> ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤</p>
            <p>ğŸ’¾ <strong>ë°±ì—… ê¶Œì¥:</strong> ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë³´ê´€í•˜ì„¸ìš”</p>
            <p>ğŸ“Š í˜„ì¬ ì €ì¥ëœ ë°ì´í„°: <span id="dataCount" class="font-bold text-blue-600">0</span>ê±´</p>
        </div>
    </div>
</div>
</div>

<!-- Registration Modal -->
<div id="registrationModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-2xl w-full mx-4">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-900">ìƒë‹´ ë“±ë¡</h3>
        <button onclick="closeRegistration()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div class="flex space-x-4 mb-6">
        <!-- File Upload Button -->
        <input id="file-upload" name="file-upload" type="file" accept=".xls,.xlsx" class="hidden" onchange="handleFileUpload(event)">
        <button onclick="document.getElementById('file-upload').click()" class="flex items-center space-x-2 btn-success text-white px-4 py-2 rounded-lg font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <span>Excel ì—…ë¡œë“œ</span>
        </button>

        <!-- Toggle Manual Input Button -->
        <button onclick="toggleManualInput()" class="flex items-center space-x-2 btn-info text-white px-4 py-2 rounded-lg font-medium">
            <svg id="toggleIcon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <span>ê°œë³„ ë“±ë¡</span>
        </button>
    </div>

    <!-- Manual Input Section -->
    <div id="manualInputSection" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <input type="text" id="customerName" placeholder="ê³ ê°ëª…" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
            <select id="customerJob" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                <option value="">ì§ì—… ì„ íƒ</option>
                <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
                <option value="ì‚¬ì—…ì">ì‚¬ì—…ì</option>
                <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
            </select>
            <input type="tel" id="customerPhone" placeholder="ì—°ë½ì²˜" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
            <select id="customerCarrier" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                <option value="">í†µì‹ ì‚¬ ì„ íƒ</option>
                <option value="SKT">SKT</option>
                <option value="KT">KT</option>
                <option value="LG">LG</option>
                <option value="SKì•Œëœ°">SKì•Œëœ°</option>
                <option value="KTì•Œëœ°">KTì•Œëœ°</option>
                <option value="LGì•Œëœ°">LGì•Œëœ°</option>
            </select>
            <input type="text" id="birthDate" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 1990-01-01)" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
            <button onclick="addConsultation()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">ë“±ë¡</button>
        </div>
    </div>
</div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="glass-card rounded-xl p-4 animate-fade-in">
    <p class="text-sm text-gray-600">ì´ ìƒë‹´</p>
    <p class="text-2xl font-bold text-gray-900" id="totalCount">0</p>
</div>
<div class="glass-card rounded-xl p-4 animate-fade-in">
    <p class="text-sm text-gray-600">ì§„í–‰ ì¤‘</p>
    <p class="text-2xl font-bold text-orange-600" id="progressCount">0</p>
</div>
<div class="glass-card rounded-xl p-4 animate-fade-in">
    <p class="text-sm text-gray-600">ìŠ¹ì¸ ì™„ë£Œ</p>
    <p class="text-2xl font-bold text-green-600" id="approvedCount">0</p>
</div>
<div class="glass-card rounded-xl p-4 animate-fade-in">
    <p class="text-sm text-gray-600">ì„ íƒëœ í•­ëª©</p>
    <p class="text-2xl font-bold text-blue-600" id="selectedCount">0</p>
</div>
</div>

<!-- Category Tabs -->
<div class="glass-card rounded-2xl mb-6 animate-fade-in">
<!-- Search Bar -->
<div class="p-4 border-b">
    <div class="flex items-center space-x-4">
        <div class="flex-1">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="ê³ ê°ëª… ë˜ëŠ” ì—°ë½ì²˜ë¡œ ê²€ìƒ‰ (ë¶€ë¶„ ê²€ìƒ‰ ê°€ëŠ¥)" 
                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-sm"
                       onkeyup="handleSearch(event)">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <button onclick="clearSearch()" class="px-4 py-3 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg transition-colors">
            ì´ˆê¸°í™”
        </button>
    </div>
</div>

<div class="flex flex-wrap border-b">
    <button onclick="showCategory('all')" class="category-tab active px-6 py-4 font-medium text-sm" data-category="all">ì „ì²´</button>
    <button onclick="showCategory('ìƒë‹´ëŒ€ê¸°')" class="category-tab px-6 py-4 font-medium text-sm" data-category="ìƒë‹´ëŒ€ê¸°">ìƒë‹´ëŒ€ê¸°</button>
    <button onclick="showCategory('1ì°¨ì½œì™„ë£Œ')" class="category-tab px-6 py-4 font-medium text-sm" data-category="1ì°¨ì½œì™„ë£Œ">1ì°¨ì½œì™„ë£Œ</button>
    <button onclick="showCategory('ì§„í–‰ì¤‘')" class="category-tab px-6 py-4 font-medium text-sm" data-category="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</button>
    <button onclick="showCategory('â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸')" class="category-tab px-6 py-4 font-medium text-sm" data-category="â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸">â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸</button>
    <button onclick="showCategory('ë¶€ì¬')" class="category-tab px-6 py-4 font-medium text-sm" data-category="ë¶€ì¬">ë¶€ì¬</button>
    <button onclick="showCategory('ë¶€ê²°')" class="category-tab px-6 py-4 font-medium text-sm" data-category="ë¶€ê²°">ë¶€ê²°</button>
    <button onclick="showCategory('A/S')" class="category-tab px-6 py-4 font-medium text-sm" data-category="A/S">A/S</button>
    <button onclick="showCategory('ì¬ì»¨íƒ')" class="category-tab px-6 py-4 font-medium text-sm" data-category="ì¬ì»¨íƒ">ì¬ì»¨íƒ</button>
</div>

<!-- Consultation List -->
<div class="p-5">
    <div class="overflow-x-auto">
        <table class="w-full compact-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="checkbox-custom">
                    </th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">DB</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ê³ ê°ëª…</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ìƒë…„ì›”ì¼</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ì§ì—…</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ì—°ë½ì²˜</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">í†µì‹ ì‚¬</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ë©”ëª¨</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ìƒë‹´ìƒíƒœ</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ë‹´ë‹¹ì</th>
                    <th class="text-left text-xs font-medium text-gray-500 uppercase">ë“±ë¡ì¼</th>
                </tr>
            </thead>
            <tbody id="consultationList" class="bg-white divide-y divide-gray-100">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>
</div>
</div>
</div>

<!-- ì—¬ê¸°ì— ê¸°ì¡´ì˜ ëª¨ë“  ëª¨ë‹¬ë“¤ì„ í¬í•¨ -->
<!-- Status Change Modal -->
<div id="statusModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-semibold text-gray-900 mb-4">ìƒë‹´ìƒíƒœ ë³€ê²½</h3>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">ê³ ê°ëª…</label>
<p id="modalCustomerName" class="text-gray-900 font-semibold"></p>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">í˜„ì¬ ìƒíƒœ</label>
<p id="currentStatus" class="text-gray-900 font-semibold"></p>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ë³€ê²½í•  ìƒíƒœ</label>
<select id="newStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
    <option value="ìƒë‹´ëŒ€ê¸°">ìƒë‹´ëŒ€ê¸°</option>
    <option value="1ì°¨ì½œì™„ë£Œ">1ì°¨ì½œì™„ë£Œ</option>
    <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
    <option value="â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸">â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸</option>
    <option value="ë¶€ì¬">ë¶€ì¬</option>
    <option value="ë¶€ê²°">ë¶€ê²°</option>
    <option value="A/S">A/S</option>
    <option value="ì¬ì»¨íƒ">ì¬ì»¨íƒ</option>
</select>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="updateStatus()" class="btn-primary text-white px-4 py-2 rounded-lg">ë³€ê²½</button>
</div>
</div>
</div>

<!-- Batch Status Change Modal -->
<div id="batchStatusModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-semibold text-gray-900 mb-4">ì²´í¬ëª©ë¡ ìƒíƒœë³€ê²½</h3>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">ì„ íƒëœ í•­ëª©</label>
<p id="batchSelectedCount" class="text-gray-900 font-semibold">0ê°œ</p>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ë³€ê²½í•  ìƒíƒœ</label>
<select id="batchNewStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
    <option value="ìƒë‹´ëŒ€ê¸°">ìƒë‹´ëŒ€ê¸°</option>
    <option value="1ì°¨ì½œì™„ë£Œ">1ì°¨ì½œì™„ë£Œ</option>
    <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
    <option value="â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸">â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸</option>
    <option value="ë¶€ì¬">ë¶€ì¬</option>
    <option value="ë¶€ê²°">ë¶€ê²°</option>
    <option value="A/S">A/S</option>
    <option value="ì¬ì»¨íƒ">ì¬ì»¨íƒ</option>
</select>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeBatchModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="updateBatchStatus()" class="btn-primary text-white px-4 py-2 rounded-lg">ì¼ê´„ ë³€ê²½</button>
</div>
</div>
</div>

<!-- Batch Delete Modal -->
<div id="batchDeleteModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-semibold text-gray-900 mb-4">ì²´í¬ëª©ë¡ ì‚­ì œ</h3>
<div class="mb-4">
<p class="text-gray-700">ì„ íƒëœ <span id="deleteSelectedCount" class="font-semibold text-red-600">0ê°œ</span> í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
<p class="text-sm text-red-500 mt-2">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeBatchDeleteModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="deleteBatchItems()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">ì‚­ì œ</button>
</div>
</div>
</div>

<!-- Memo Modal -->
<div id="memoModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-lg w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">ë©”ëª¨ í¸ì§‘</h3>
<button onclick="closeMemoModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">ê³ ê°ëª…</label>
<p id="memoCustomerName" class="text-gray-900 font-semibold"></p>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨</label>
<textarea id="memoText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeMemoModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveMemo()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<!-- Edit Name Modal -->
<div id="editNameModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">ê³ ê°ëª… í¸ì§‘</h3>
<button onclick="closeEditNameModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ê³ ê°ëª…</label>
<input type="text" id="editNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeEditNameModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveEditName()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<!-- Edit Phone Modal -->
<div id="editPhoneModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">ì—°ë½ì²˜ í¸ì§‘</h3>
<button onclick="closeEditPhoneModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜</label>
<input type="tel" id="editPhoneInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeEditPhoneModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveEditPhone()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<!-- Edit Job Modal -->
<div id="editJobModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">ì§ì—… í¸ì§‘</h3>
<button onclick="closeEditJobModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ì§ì—…</label>
<select id="editJobSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
    <option value="">ì§ì—… ì„ íƒ</option>
    <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
    <option value="ì‚¬ì—…ì">ì‚¬ì—…ì</option>
    <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
</select>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeEditJobModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveEditJob()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<!-- Edit Carrier Modal -->
<div id="editCarrierModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">í†µì‹ ì‚¬ í¸ì§‘</h3>
<button onclick="closeEditCarrierModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">í†µì‹ ì‚¬</label>
<select id="editCarrierSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
    <option value="">í†µì‹ ì‚¬ ì„ íƒ</option>
    <option value="SKT">SKT</option>
    <option value="KT">KT</option>
    <option value="LG">LG</option>
    <option value="SKì•Œëœ°">SKì•Œëœ°</option>
    <option value="KTì•Œëœ°">KTì•Œëœ°</option>
    <option value="LGì•Œëœ°">LGì•Œëœ°</option>
</select>
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeEditCarrierModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveEditCarrier()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<!-- Edit Birth Modal -->
<div id="editBirthModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
<div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-gray-900">ìƒë…„ì›”ì¼ í¸ì§‘</h3>
<button onclick="closeEditBirthModal()" class="text-gray-500 hover:text-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
</button>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">ìƒë…„ì›”ì¼</label>
<input type="text" id="editBirthInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" placeholder="ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1990-01-01)">
</div>
<div class="flex justify-end space-x-3">
<button onclick="closeEditBirthModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
<button onclick="saveEditBirth()" class="btn-primary text-white px-4 py-2 rounded-lg">ì €ì¥</button>
</div>
</div>
</div>

<script>
// ===== ì™„ì „í•œ ì˜êµ¬ ë³´ì¡´ ì‹œìŠ¤í…œ =====
class PersistentDataManager {
    constructor() {
        this.storageKey = 'bestron_consultations_db';
        this.loginKey = 'bestron_login_status';
        this.backupInterval = null;
        this.init();
    }

    init() {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœì™€ ë°ì´í„° ë³µì›
        this.loadLoginStatus();
        this.loadData();
        
        // DOMì— ì˜êµ¬ ì €ì¥ì†Œ ìƒì„±
        this.createPermanentStorage();
        
        // ì¦‰ì‹œ ì €ì¥
        this.saveData();
        this.saveLoginStatus();
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìë™ ì €ì¥
        window.addEventListener('beforeunload', () => {
            this.saveData();
            this.saveLoginStatus();
        });

        // ë§¤ìš° ìì£¼ ìë™ ì €ì¥ (5ì´ˆë§ˆë‹¤)
        this.backupInterval = setInterval(() => {
            this.saveData();
            this.saveLoginStatus();
        }, 5000);

        // ëª¨ë“  ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì—ì„œ ì €ì¥
        document.addEventListener('click', () => {
            setTimeout(() => this.saveData(), 100);
        });

        // í‚¤ë³´ë“œ ì…ë ¥ ì‹œë„ ì €ì¥
        document.addEventListener('keyup', () => {
            setTimeout(() => this.saveData(), 500);
        });
    }

    createPermanentStorage() {
        // ì—¬ëŸ¬ ê°œì˜ ìˆ¨ê²¨ì§„ ì €ì¥ì†Œ ìƒì„±
        for (let i = 1; i <= 5; i++) {
            let storage = document.getElementById(`hiddenStorage${i}`);
            if (!storage) {
                storage = document.createElement('div');
                storage.id = `hiddenStorage${i}`;
                storage.style.display = 'none';
                storage.setAttribute('data-storage', 'permanent');
                document.body.appendChild(storage);
            }
        }

        // ë©”íƒ€ íƒœê·¸ë“¤ë„ ì—¬ëŸ¬ ê°œ ìƒì„±
        for (let i = 1; i <= 3; i++) {
            let metaStorage = document.querySelector(`meta[name="app-data-${i}"]`);
            if (!metaStorage) {
                metaStorage = document.createElement('meta');
                metaStorage.name = `app-data-${i}`;
                document.head.appendChild(metaStorage);
            }
        }
    }

    saveLoginStatus() {
        try {
            const loginStatus = {
                isLoggedIn: !document.getElementById('mainApp').classList.contains('hidden'),
                timestamp: Date.now()
            };

            // ì—¬ëŸ¬ ê³³ì— ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
            window.bestronLoginStatus = loginStatus;
            
            // DOMì—ë„ ì €ì¥
            const loginStorage = document.getElementById('hiddenStorage1');
            if (loginStorage) {
                loginStorage.setAttribute('data-login', JSON.stringify(loginStatus));
            }

            // ë©”íƒ€ íƒœê·¸ì—ë„ ì €ì¥
            const metaLogin = document.querySelector('meta[name="app-data-1"]');
            if (metaLogin) {
                metaLogin.setAttribute('data-login', encodeURIComponent(JSON.stringify(loginStatus)));
            }

            console.log('ğŸ” ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥:', loginStatus.isLoggedIn);
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }

    loadLoginStatus() {
        try {
            let loginStatus = null;

            // ë©”ëª¨ë¦¬ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (window.bestronLoginStatus) {
                loginStatus = window.bestronLoginStatus;
            }
            
            // DOMì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!loginStatus) {
                const loginStorage = document.getElementById('hiddenStorage1');
                if (loginStorage && loginStorage.getAttribute('data-login')) {
                    loginStatus = JSON.parse(loginStorage.getAttribute('data-login'));
                }
            }

            // ë©”íƒ€ íƒœê·¸ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!loginStatus) {
                const metaLogin = document.querySelector('meta[name="app-data-1"]');
                if (metaLogin && metaLogin.getAttribute('data-login')) {
                    const decoded = decodeURIComponent(metaLogin.getAttribute('data-login'));
                    loginStatus = JSON.parse(decoded);
                }
            }

            // ë¡œê·¸ì¸ ìƒíƒœê°€ ìˆê³  ìµœê·¼ ê²ƒì´ë¼ë©´ ìë™ ë¡œê·¸ì¸
            if (loginStatus && loginStatus.isLoggedIn) {
                const timeDiff = Date.now() - loginStatus.timestamp;
                if (timeDiff < 24 * 60 * 60 * 1000) { // 24ì‹œê°„ ì´ë‚´
                    console.log('ğŸ” ìë™ ë¡œê·¸ì¸ ì‹¤í–‰');
                    this.autoLogin();
                    return true;
                }
            }

            console.log('ğŸ” ë¡œê·¸ì¸ í•„ìš”');
            return false;
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            return false;
        }
    }

    autoLogin() {
        try {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            // ì•± ì´ˆê¸°í™”ëŠ” ë°ì´í„° ë¡œë“œ í›„ì— ì‹¤í–‰ë¨
        } catch (error) {
            console.error('ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
        }
    }

    saveData() {
        try {
            const dataToSave = {
                consultations: consultations,
                lastSaved: new Date().toISOString(),
                version: '3.0',
                checksum: this.generateChecksum(consultations),
                timestamp: Date.now()
            };
            
            // ë©”ëª¨ë¦¬ì— ì €ì¥ (ì—¬ëŸ¬ ê³³ì—)
            window.bestronData = dataToSave;
            window._consultations = [...consultations];
            window._backup1 = JSON.stringify(dataToSave);
            window._backup2 = JSON.stringify(dataToSave);

            // DOM ì—¬ëŸ¬ ê³³ì— ì €ì¥
            for (let i = 2; i <= 5; i++) {
                const storage = document.getElementById(`hiddenStorage${i}`);
                if (storage) {
                    if (i === 2 || i === 3) {
                        // ì „ì²´ ë°ì´í„° ì €ì¥
                        storage.textContent = JSON.stringify(dataToSave);
                    } else {
                        // ìƒë‹´ ë°ì´í„°ë§Œ ì €ì¥
                        storage.textContent = JSON.stringify(consultations);
                    }
                    storage.setAttribute('data-timestamp', Date.now().toString());
                }
            }

            // ë©”íƒ€ íƒœê·¸ì— ì €ì¥
            for (let i = 2; i <= 3; i++) {
                const metaStorage = document.querySelector(`meta[name="app-data-${i}"]`);
                if (metaStorage) {
                    if (JSON.stringify(dataToSave).length < 8000) {
                        metaStorage.content = encodeURIComponent(JSON.stringify(dataToSave));
                    } else {
                        // ë°ì´í„°ê°€ í´ ê²½ìš° ìƒë‹´ ë°ì´í„°ë§Œ ì €ì¥
                        metaStorage.content = encodeURIComponent(JSON.stringify(consultations));
                    }
                }
            }

            // URL í•´ì‹œì—ë„ ì €ì¥ (ì‘ì€ ë°ì´í„°ë§Œ)
            if (consultations.length <= 10) {
                const smallData = {
                    consultations: consultations,
                    saved: Date.now()
                };
                try {
                    window.location.hash = encodeURIComponent(JSON.stringify(smallData));
                } catch (e) {
                    // URL ì €ì¥ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                }
            }
            
            console.log('ğŸ’¾ ì „ì²´ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', consultations.length + 'ê±´');
            
        } catch (error) {
            console.error('âŒ ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
        }
    }

    loadData() {
        try {
            let loadedData = null;
            let dataSource = '';
            
            // 1. ë©”ëª¨ë¦¬ì—ì„œ ë³µì› ì‹œë„ (ì—¬ëŸ¬ ë°±ì—… í™•ì¸)
            if (window.bestronData && window.bestronData.consultations) {
                loadedData = window.bestronData;
                dataSource = 'ë©”ëª¨ë¦¬ 1ì°¨';
            } else if (window._consultations && Array.isArray(window._consultations)) {
                consultations = [...window._consultations];
                console.log('ğŸ“‚ ë©”ëª¨ë¦¬ 2ì°¨ì—ì„œ ë°ì´í„° ë³µì›:', consultations.length + 'ê±´');
                return true;
            } else if (window._backup1) {
                loadedData = JSON.parse(window._backup1);
                dataSource = 'ë©”ëª¨ë¦¬ ë°±ì—… 1';
            } else if (window._backup2) {
                loadedData = JSON.parse(window._backup2);
                dataSource = 'ë©”ëª¨ë¦¬ ë°±ì—… 2';
            }
            
            // 2. DOMì—ì„œ ë³µì› ì‹œë„
            if (!loadedData) {
                for (let i = 2; i <= 5; i++) {
                    const storage = document.getElementById(`hiddenStorage${i}`);
                    if (storage && storage.textContent) {
                        try {
                            const data = JSON.parse(storage.textContent);
                            if (Array.isArray(data)) {
                                // ìƒë‹´ ë°ì´í„° ë°°ì—´
                                consultations = data;
                                console.log(`ğŸ“‚ DOM Storage ${i}ì—ì„œ ìƒë‹´ ë°ì´í„° ë³µì›:`, consultations.length + 'ê±´');
                                return true;
                            } else if (data.consultations) {
                                // ì „ì²´ ë°ì´í„° ê°ì²´
                                loadedData = data;
                                dataSource = `DOM Storage ${i}`;
                                break;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }
            }

            // 3. ë©”íƒ€ íƒœê·¸ì—ì„œ ë³µì› ì‹œë„
            if (!loadedData) {
                for (let i = 2; i <= 3; i++) {
                    const metaStorage = document.querySelector(`meta[name="app-data-${i}"]`);
                    if (metaStorage && metaStorage.content) {
                        try {
                            const decoded = decodeURIComponent(metaStorage.content);
                            const data = JSON.parse(decoded);
                            if (Array.isArray(data)) {
                                consultations = data;
                                console.log(`ğŸ“‚ Meta ${i}ì—ì„œ ìƒë‹´ ë°ì´í„° ë³µì›:`, consultations.length + 'ê±´');
                                return true;
                            } else if (data.consultations) {
                                loadedData = data;
                                dataSource = `Meta ${i}`;
                                break;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }
            }

            // 4. URL í•´ì‹œì—ì„œ ë³µì› ì‹œë„
            if (!loadedData && window.location.hash) {
                try {
                    const hashData = decodeURIComponent(window.location.hash.substring(1));
                    const data = JSON.parse(hashData);
                    if (data.consultations) {
                        loadedData = data;
                        dataSource = 'URL í•´ì‹œ';
                    }
                } catch (e) {
                    // URL ë³µì› ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                }
            }

            // ë°ì´í„° ê²€ì¦ ë° ì ìš©
            if (loadedData && loadedData.consultations && Array.isArray(loadedData.consultations)) {
                consultations = loadedData.consultations;
                console.log(`ğŸ“‚ ${dataSource}ì—ì„œ ë°ì´í„° ë³µì›:`, consultations.length + 'ê±´');
                return true;
            }

            // 5. ëª¨ë“  ë³µì› ì‹¤íŒ¨ ì‹œ ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
            console.log('ğŸ“‚ ìƒˆë¡œìš´ ì„¸ì…˜ - ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ');
            this.loadSampleData();
            return false;
            
        } catch (error) {
            console.error('âŒ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            this.loadSampleData();
            return false;
        }
    }

    generateChecksum(data) {
        // ê°„ë‹¨í•œ ì²´í¬ì„¬ ìƒì„±
        let hash = 0;
        const str = JSON.stringify(data);
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
        }
        return hash.toString();
    }

    loadSampleData() {
        const today = new Date().toLocaleDateString('ko-KR');
        const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('ko-KR');

        consultations = [
            {
                id: 1,
                dbNumber: 1,
                name: 'ê¹€ì² ìˆ˜',
                job: 'ì§ì¥ì¸',
                phone: '010-1234-5678',
                carrier: 'SKT',
                birthDate: '1985-03-15',
                date: today,
                status: 'ìƒë‹´ëŒ€ê¸°',
                memo: 'ì˜¤í›„ 3ì‹œ ì´í›„ í†µí™” ê°€ëŠ¥',
                manager: 'ìƒí˜„'
            },
            {
                id: 2,
                dbNumber: 2,
                name: 'ë°•ì˜í¬',
                job: 'ì‚¬ì—…ì',
                phone: '010-9876-5432',
                carrier: 'KT',
                birthDate: '1978-11-22',
                date: yesterday,
                status: 'ì§„í–‰ì¤‘',
                memo: 'ì„œë¥˜ ê²€í†  ì¤‘',
                manager: 'ë¯¼ì„±'
            },
            {
                id: 3,
                dbNumber: 3,
                name: 'ì´ë¯¼ìˆ˜',
                job: 'í”„ë¦¬ëœì„œ',
                phone: '010-5555-7777',
                carrier: 'LG',
                birthDate: '1990-07-08',
                date: today,
                status: 'â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸',
                memo: 'ìŠ¹ì¸ ì™„ë£Œë¨',
                manager: 'ìƒí˜„'
            }
        ];
    }

    compressData(data) {
        // ê°„ë‹¨í•œ JSON ì••ì¶• (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ì••ì¶• ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš© ê°€ëŠ¥)
        return btoa(JSON.stringify(data));
    }

    decompressData(compressedData) {
        try {
            return JSON.parse(atob(compressedData));
        } catch {
            return null;
        }
    }

    exportToFile() {
        const dataToExport = {
            consultations: consultations,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };

        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
            type: 'application/json'
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bestron_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    importFromFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.consultations && Array.isArray(data.consultations)) {
                        consultations = data.consultations;
                        this.saveData();
                        resolve(data.consultations.length);
                    } else {
                        reject('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
                    }
                } catch (error) {
                    reject('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
        });
    }

    clearAllData() {
        consultations = [];
        window.bestronData = null;
        window.location.hash = '';
        this.saveData();
    }
}

// ì „ì—­ ë³€ìˆ˜ë“¤
let consultations = [];
let currentEditIndex = -1;
let currentCategory = 'all';
let selectedItems = new Set();
let currentMemoIndex = -1;
let currentEditNameIndex = -1;
let currentEditPhoneIndex = -1;
let currentEditJobIndex = -1;
let currentEditCarrierIndex = -1;
let currentEditBirthIndex = -1;
let searchTerm = '';

// ë°ì´í„° ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤
const dataManager = new PersistentDataManager();

const statusStyles = {
    'ìƒë‹´ëŒ€ê¸°': 'status-waiting',
    '1ì°¨ì½œì™„ë£Œ': 'status-first-call',
    'ì§„í–‰ì¤‘': 'status-in-progress',
    'â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸': 'status-approved',
    'ë¶€ì¬': 'status-absent',
    'ë¶€ê²°': 'status-rejected',
    'A/S': 'status-as',
    'ì¬ì»¨íƒ': 'status-recontact'
};

// ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤
function downloadBackup() {
    dataManager.exportToFile();
    alert('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function restoreFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    dataManager.importFromFile(file)
        .then(count => {
            updateConsultationList();
            updateStats();
            updateDataCount();
            alert(`${count}ê±´ì˜ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        })
        .catch(error => {
            alert(`ë³µì› ì‹¤íŒ¨: ${error}`);
        });

    event.target.value = '';
}

function clearAllData() {
    if (confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('âš ï¸ ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.')) {
            dataManager.clearAllData();
            updateConsultationList();
            updateStats();
            updateDataCount();
            alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
}

function toggleDataManagement() {
    updateDataCount();
    document.getElementById('dataManagementModal').classList.remove('hidden');
    document.getElementById('dataManagementModal').classList.add('flex');
}

function closeDataManagement() {
    document.getElementById('dataManagementModal').classList.add('hidden');
    document.getElementById('dataManagementModal').classList.remove('flex');
}

function updateDataCount() {
    document.getElementById('dataCount').textContent = consultations.length;
}

// ìë™ ì €ì¥ í•¨ìˆ˜
function autoSave() {
    dataManager.saveData();
}

function handleLogin(event) {
    event.preventDefault();
    const id = document.getElementById('loginId').value;
    const password = document.getElementById('loginPassword').value;

    if (id === 'best101' && password === 'best101') {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
        dataManager.saveLoginStatus();
        
        // ì•± ì´ˆê¸°í™”
        initializeApp();
        
        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ ë° ìƒíƒœ ì €ì¥');
    } else {
        alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ì €ì¥
        dataManager.logout();
        
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginId').value = '';
        document.getElementById('loginPassword').value = '';
        
        console.log('âœ… ë¡œê·¸ì•„ì›ƒ ë° ìƒíƒœ ì €ì¥');
    }
}

function initializeApp() {
    // ë°ì´í„°ëŠ” ì´ë¯¸ PersistentDataManagerê°€ ë¡œë“œí–ˆìŒ
    updateConsultationList();
    updateStats();
    updateDataCount();
    
    // ì¦‰ì‹œ ì €ì¥
    dataManager.saveData();
    
    console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì™„ë£Œ, ë°ì´í„° ê±´ìˆ˜:', consultations.length);
}

function toggleRegistration() {
    document.getElementById('registrationModal').classList.remove('hidden');
    document.getElementById('registrationModal').classList.add('flex');
}

function closeRegistration() {
    document.getElementById('registrationModal').classList.add('hidden');
    document.getElementById('registrationModal').classList.remove('flex');
}

function toggleManualInput() {
    const section = document.getElementById('manualInputSection');
    const icon = document.getElementById('toggleIcon');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        section.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

function addConsultation() {
    const name = document.getElementById('customerName').value.trim();
    const job = document.getElementById('customerJob').value;
    const phone = document.getElementById('customerPhone').value.trim();
    const carrier = document.getElementById('customerCarrier').value;
    const birthDate = document.getElementById('birthDate').value.trim();

    if (!name || !job || !phone || !carrier || !birthDate) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const newDbNumber = consultations.length > 0 ? Math.max(...consultations.map(c => c.dbNumber || 0)) + 1 : 1;

    const consultation = {
        id: Date.now(),
        dbNumber: newDbNumber,
        name: name,
        job: job,
        phone: phone,
        carrier: carrier,
        birthDate: birthDate,
        date: new Date().toLocaleDateString('ko-KR'),
        status: 'ìƒë‹´ëŒ€ê¸°',
        memo: '',
        manager: ''
    };

    consultations.push(consultation);
    updateConsultationList();
    updateStats();
    autoSave();

    // Clear form
    document.getElementById('customerName').value = '';
    document.getElementById('customerJob').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerCarrier').value = '';
    document.getElementById('birthDate').value = '';

    alert('ìƒë‹´ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            processExcelData(jsonData);
        } catch (error) {
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

function processExcelData(data) {
    if (data.length < 2) {
        alert('ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    const headers = data[0].map(header => header?.toString().trim());
    let nameIndex = -1, jobIndex = -1, phoneIndex = -1, carrierIndex = -1, birthIndex = -1;

    console.log('ì›ë³¸ í—¤ë”:', headers);

    // ë” ê°•ë ¥í•œ ì»¬ëŸ¼ ë§¤í•‘ ë¡œì§
    headers.forEach((header, index) => {
        if (!header) return;

        const cleanHeader = header.toLowerCase().replace(/[\s\-_\.]/g, '');
        console.log(`ì¸ë±ìŠ¤ ${index}: "${header}" -> "${cleanHeader}"`);

        // ê³ ê°ëª…/ì´ë¦„ ì»¬ëŸ¼ ì°¾ê¸°
        if (nameIndex === -1) {
            if (cleanHeader === 'ê³ ê°ëª…' || cleanHeader === 'ì´ë¦„' || cleanHeader === 'ì„±ëª…' || 
                cleanHeader === 'name' || cleanHeader === 'ê³ ê°ì´ë¦„' || cleanHeader === 'ì„±í•¨' ||
                cleanHeader.includes('ê³ ê°ëª…') || cleanHeader.includes('ì´ë¦„') || cleanHeader.includes('ì„±ëª…')) {
                nameIndex = index;
                console.log('ê³ ê°ëª… ì»¬ëŸ¼ ì°¾ìŒ:', header, 'ì¸ë±ìŠ¤:', index);
            }
        }

        // ì—°ë½ì²˜/ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ ì°¾ê¸°
        if (phoneIndex === -1) {
            if (cleanHeader === 'ì—°ë½ì²˜' || cleanHeader === 'ì „í™”ë²ˆí˜¸' || cleanHeader === 'íœ´ëŒ€í°' || 
                cleanHeader === 'ì „í™”' || cleanHeader === 'phone' || cleanHeader === 'mobile' || 
                cleanHeader === 'tel' || cleanHeader === 'í•¸ë“œí°' || cleanHeader === 'í°ë²ˆí˜¸' ||
                cleanHeader.includes('ì—°ë½ì²˜') || cleanHeader.includes('ì „í™”') || cleanHeader.includes('íœ´ëŒ€í°') ||
                cleanHeader.includes('phone') || cleanHeader.includes('mobile') || cleanHeader.includes('tel')) {
                phoneIndex = index;
                console.log('ì—°ë½ì²˜ ì»¬ëŸ¼ ì°¾ìŒ:', header, 'ì¸ë±ìŠ¤:', index);
            }
        }

        // ì§ì—… ì»¬ëŸ¼ ì°¾ê¸°
        if (jobIndex === -1) {
            if (cleanHeader === 'ì§ì—…' || cleanHeader === 'job' || cleanHeader === 'occupation' || 
                cleanHeader === 'ì—…ë¬´' || cleanHeader === 'ì§ë¬´' || cleanHeader === 'ì§ì¢…' ||
                cleanHeader.includes('ì§ì—…') || cleanHeader.includes('job')) {
                jobIndex = index;
                console.log('ì§ì—… ì»¬ëŸ¼ ì°¾ìŒ:', header, 'ì¸ë±ìŠ¤:', index);
            }
        }

        // í†µì‹ ì‚¬ ì»¬ëŸ¼ ì°¾ê¸°
        if (carrierIndex === -1) {
            if (cleanHeader === 'í†µì‹ ì‚¬' || cleanHeader === 'carrier' || cleanHeader === 'í†µì‹ ' ||
                cleanHeader === 'ì´ë™í†µì‹ ì‚¬' || cleanHeader === 'ìºë¦¬ì–´' ||
                cleanHeader.includes('í†µì‹ ì‚¬') || cleanHeader.includes('carrier') || cleanHeader.includes('í†µì‹ ')) {
                carrierIndex = index;
                console.log('í†µì‹ ì‚¬ ì»¬ëŸ¼ ì°¾ìŒ:', header, 'ì¸ë±ìŠ¤:', index);
            }
        }

        // ìƒë…„ì›”ì¼ ì»¬ëŸ¼ ì°¾ê¸°
        if (birthIndex === -1) {
            if (cleanHeader === 'ìƒë…„ì›”ì¼' || cleanHeader === 'ìƒì¼' || cleanHeader === 'birth' || 
                cleanHeader === 'birthday' || cleanHeader === 'ë…„ì›”ì¼' || cleanHeader === 'ìƒë…„' ||
                cleanHeader.includes('ìƒë…„ì›”ì¼') || cleanHeader.includes('ìƒì¼') || cleanHeader.includes('birth')) {
                birthIndex = index;
                console.log('ìƒë…„ì›”ì¼ ì»¬ëŸ¼ ì°¾ìŒ:', header, 'ì¸ë±ìŠ¤:', index);
            }
        }
    });

    // ì—°ë½ì²˜ ì»¬ëŸ¼ì„ ëª» ì°¾ì•˜ì„ ê²½ìš° ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ì»¬ëŸ¼ì„ ì°¾ê¸°
    if (phoneIndex === -1) {
        console.log('ì—°ë½ì²˜ ì»¬ëŸ¼ì„ í—¤ë”ë¡œ ì°¾ì§€ ëª»í•¨. ë°ì´í„° íŒ¨í„´ìœ¼ë¡œ ì°¾ëŠ” ì¤‘...');
        for (let colIndex = 0; colIndex < headers.length; colIndex++) {
            let phonePatternCount = 0;
            for (let rowIndex = 1; rowIndex < Math.min(data.length, 10); rowIndex++) {
                const cellValue = data[rowIndex][colIndex]?.toString().trim();
                if (cellValue && /^[0-9\-\s\(\)]+$/.test(cellValue) && cellValue.length >= 10) {
                    phonePatternCount++;
                }
            }
            if (phonePatternCount >= 2) {
                phoneIndex = colIndex;
                console.log('ë°ì´í„° íŒ¨í„´ìœ¼ë¡œ ì—°ë½ì²˜ ì»¬ëŸ¼ ì°¾ìŒ:', headers[colIndex], 'ì¸ë±ìŠ¤:', colIndex);
                break;
            }
        }
    }

    console.log('ìµœì¢… ë§¤í•‘ ê²°ê³¼:');
    console.log('ê³ ê°ëª…:', nameIndex >= 0 ? `${headers[nameIndex]} (${nameIndex})` : 'ì—†ìŒ');
    console.log('ì—°ë½ì²˜:', phoneIndex >= 0 ? `${headers[phoneIndex]} (${phoneIndex})` : 'ì—†ìŒ');
    console.log('ì§ì—…:', jobIndex >= 0 ? `${headers[jobIndex]} (${jobIndex})` : 'ì—†ìŒ');
    console.log('í†µì‹ ì‚¬:', carrierIndex >= 0 ? `${headers[carrierIndex]} (${carrierIndex})` : 'ì—†ìŒ');
    console.log('ìƒë…„ì›”ì¼:', birthIndex >= 0 ? `${headers[birthIndex]} (${birthIndex})` : 'ì—†ìŒ');

    if (nameIndex === -1 || phoneIndex === -1) {
        let errorMsg = 'í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n';
        errorMsg += 'í•„ìš”í•œ ì»¬ëŸ¼: ê³ ê°ëª…(ì´ë¦„), ì—°ë½ì²˜(ì „í™”ë²ˆí˜¸)\n';
        errorMsg += 'ì„ íƒ ì»¬ëŸ¼: ì§ì—…, í†µì‹ ì‚¬, ìƒë…„ì›”ì¼\n\n';
        errorMsg += 'í˜„ì¬ ë°œê²¬ëœ í—¤ë”:\n';
        headers.forEach((header, index) => {
            errorMsg += `${index + 1}. ${header}\n`;
        });
        errorMsg += '\në§¤í•‘ ê²°ê³¼:\n';
        errorMsg += `ê³ ê°ëª…: ${nameIndex >= 0 ? headers[nameIndex] : 'ì°¾ì§€ ëª»í•¨'}\n`;
        errorMsg += `ì—°ë½ì²˜: ${phoneIndex >= 0 ? headers[phoneIndex] : 'ì°¾ì§€ ëª»í•¨'}\n`;
        alert(errorMsg);
        return;
    }

    let successCount = 0;
    let errorCount = 0;
    const today = new Date().toLocaleDateString('ko-KR');

    // í˜„ì¬ ìµœëŒ€ DB ë²ˆí˜¸ ê³„ì‚°
    const maxDbNumber = consultations.length > 0 ? Math.max(...consultations.map(c => c.dbNumber || 0)) : 0;

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length === 0) continue;

        const name = row[nameIndex]?.toString().trim();
        const job = jobIndex >= 0 ? (row[jobIndex]?.toString().trim() || '') : '';
        let phone = row[phoneIndex]?.toString().trim();
        const carrier = carrierIndex >= 0 ? (row[carrierIndex]?.toString().trim() || '') : '';
        const birthDate = birthIndex >= 0 ? (row[birthIndex]?.toString().trim() || '') : '';

        console.log(`í–‰ ${i}: ì´ë¦„="${name}", ì „í™”="${phone}"`);

        // ì „í™”ë²ˆí˜¸ ì •ë¦¬ ë° ê²€ì¦
        if (phone) {
            phone = phone.replace(/[^0-9]/g, '');

            if (phone.length === 11 && phone.startsWith('010')) {
                phone = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (phone.length === 11 && (phone.startsWith('011') || phone.startsWith('016') || phone.startsWith('017') || phone.startsWith('018') || phone.startsWith('019'))) {
                phone = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (phone.length === 10) {
                phone = phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            } else if (phone.length < 10 || phone.length > 11) {
                console.log(`ì˜ëª»ëœ ì „í™”ë²ˆí˜¸ í˜•ì‹: ${phone} (ê¸¸ì´: ${phone.length})`);
                phone = '';
            }
        }

        if (name && phone) {
            const isDuplicate = consultations.some(c => 
                c.name === name && c.phone === phone
            );

            if (!isDuplicate) {
                const consultation = {
                    id: Date.now() + i + Math.random() * 1000,
                    dbNumber: maxDbNumber + successCount + 1,
                    name: name,
                    job: job,
                    phone: phone,
                    carrier: carrier,
                    birthDate: birthDate,
                    date: today,
                    status: 'ìƒë‹´ëŒ€ê¸°',
                    memo: '',
                    manager: ''
                };
                consultations.push(consultation);
                successCount++;
                console.log(`ì¶”ê°€ë¨: DBë²ˆí˜¸ ${consultation.dbNumber}, ì´ë¦„: ${name}, ì „í™”: ${phone}`);
            } else {
                console.log(`ì¤‘ë³µ ë°ì´í„° ê±´ë„ˆëœ€: ${name}, ${phone}`);
            }
        } else {
            errorCount++;
            console.log(`í•„ìˆ˜ ë°ì´í„° ëˆ„ë½: ì´ë¦„="${name}", ì „í™”="${phone}"`);
        }
    }

    updateConsultationList();
    updateStats();
    autoSave();

    let message = `ì—‘ì…€ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì„±ê³µ: ${successCount}ê±´ ë“±ë¡`;
    if (errorCount > 0) {
        message += `\nì‹¤íŒ¨/ì¤‘ë³µ: ${errorCount}ê±´`;
    }
    alert(message);

    event.target.value = '';
    closeRegistration();
}

function handleSearch(event) {
    searchTerm = event.target.value.toLowerCase().trim();
    updateConsultationList();
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    searchTerm = '';
    updateConsultationList();
}

function filterConsultations() {
    let filtered = consultations;

    if (currentCategory !== 'all') {
        filtered = filtered.filter(c => c.status === currentCategory);
    }

    if (searchTerm) {
        filtered = filtered.filter(c => {
            const nameMatch = c.name.toLowerCase().includes(searchTerm);
            const phoneMatch = c.phone.replace(/-/g, '').includes(searchTerm.replace(/-/g, ''));
            return nameMatch || phoneMatch;
        });
    }

    return filtered;
}

function showCategory(category) {
    currentCategory = category;

    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('active');

    updateConsultationList();
    clearSelection();
}

function updateConsultationList() {
    const tbody = document.getElementById('consultationList');
    tbody.innerHTML = '';

    const filteredConsultations = filterConsultations();

    filteredConsultations.forEach((consultation) => {
        const globalIndex = consultations.findIndex(c => c.id === consultation.id);
        const row = document.createElement('tr');
        row.className = 'table-row';

        const memoDisplay = consultation.memo ? 
            `<span class="text-blue-600 font-medium">${consultation.memo.length > 8 ? consultation.memo.substring(0, 8) + '...' : consultation.memo}</span>` :
            '<span class="text-gray-400">ë©”ëª¨ì—†ìŒ</span>';

        const jobDisplay = consultation.job ? 
            `<span class="text-gray-900">${consultation.job}</span>` :
            '<span class="text-gray-400">ë¯¸ì§€ì •</span>';

        const carrierDisplay = consultation.carrier ? 
            `<span class="text-gray-900">${consultation.carrier}</span>` :
            '<span class="text-gray-400">ë¯¸ì§€ì •</span>';

        const birthDisplay = consultation.birthDate ? 
            `<span class="text-gray-900">${consultation.birthDate}</span>` :
            '<span class="text-gray-400">ë¯¸ì…ë ¥</span>';

        row.innerHTML = `
            <td>
                <input type="checkbox" class="checkbox-custom" onchange="toggleSelection(${globalIndex})" ${selectedItems.has(globalIndex) ? 'checked' : ''}>
            </td>
            <td class="text-sm font-medium text-gray-900">
                ${consultation.dbNumber || '-'}
            </td>
            <td class="text-sm font-medium">
                <button onclick="openEditNameModal(${globalIndex})" class="editable-field text-gray-900 hover:text-blue-600 font-medium">
                    ${consultation.name}
                </button>
            </td>
            <td class="text-sm">
                <button onclick="openEditBirthModal(${globalIndex})" class="editable-field text-gray-700 hover:text-blue-600">
                    ${birthDisplay}
                </button>
            </td>
            <td class="text-sm">
                <button onclick="openEditJobModal(${globalIndex})" class="editable-field text-gray-700 hover:text-blue-600">
                    ${jobDisplay}
                </button>
            </td>
            <td class="text-sm">
                <button onclick="openEditPhoneModal(${globalIndex})" class="editable-field text-gray-700 hover:text-blue-600">
                    ${consultation.phone}
                </button>
            </td>
            <td class="text-sm">
                <button onclick="openEditCarrierModal(${globalIndex})" class="editable-field text-gray-700 hover:text-blue-600">
                    ${carrierDisplay}
                </button>
            </td>
            <td class="text-sm">
                <button onclick="openMemoModal(${globalIndex})" class="text-purple-600 hover:text-purple-800 transition-colors font-medium">
                    ${memoDisplay}
                </button>
            </td>
            <td>
                <select class="status-select px-1 py-0 rounded text-xs font-medium ${statusStyles[consultation.status]}" 
                        onchange="changeStatusDirect(${globalIndex}, this.value)">
                    <option value="ìƒë‹´ëŒ€ê¸°" ${consultation.status === 'ìƒë‹´ëŒ€ê¸°' ? 'selected' : ''}>ìƒë‹´ëŒ€ê¸°</option>
                    <option value="1ì°¨ì½œì™„ë£Œ" ${consultation.status === '1ì°¨ì½œì™„ë£Œ' ? 'selected' : ''}>1ì°¨ì½œì™„ë£Œ</option>
                    <option value="ì§„í–‰ì¤‘" ${consultation.status === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
                    <option value="â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸" ${consultation.status === 'â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸' ? 'selected' : ''}>â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸</option>
                    <option value="ë¶€ì¬" ${consultation.status === 'ë¶€ì¬' ? 'selected' : ''}>ë¶€ì¬</option>
                    <option value="ë¶€ê²°" ${consultation.status === 'ë¶€ê²°' ? 'selected' : ''}>ë¶€ê²°</option>
                    <option value="A/S" ${consultation.status === 'A/S' ? 'selected' : ''}>A/S</option>
                    <option value="ì¬ì»¨íƒ" ${consultation.status === 'ì¬ì»¨íƒ' ? 'selected' : ''}>ì¬ì»¨íƒ</option>
                </select>
            </td>
            <td>
                <select class="manager-select text-sm text-gray-700" 
                        onchange="changeManagerDirect(${globalIndex}, this.value)">
                    <option value="" ${!consultation.manager ? 'selected' : ''}>ë¯¸ì§€ì •</option>
                    <option value="ìƒí˜„" ${consultation.manager === 'ìƒí˜„' ? 'selected' : ''}>ìƒí˜„</option>
                    <option value="ë¯¼ì„±" ${consultation.manager === 'ë¯¼ì„±' ? 'selected' : ''}>ë¯¼ì„±</option>
                </select>
            </td>
            <td class="text-sm text-gray-700">${consultation.date}</td>
        `;
        tbody.appendChild(row);
    });
}

// ìƒë‹´ìƒíƒœ ì§ì ‘ ë³€ê²½ í•¨ìˆ˜
function changeStatusDirect(index, newStatus) {
    const oldStatus = consultations[index].status;
    
    if (newStatus !== oldStatus) {
        consultations[index].status = newStatus;
        updateConsultationList();
        updateStats();
        autoSave();

        // ìƒíƒœì— ë”°ë¥¸ ë°°ê²½ìƒ‰ ì¦‰ì‹œ ì ìš©
        const selectElement = event.target;
        selectElement.className = `status-select px-1 py-0 rounded text-xs font-medium ${statusStyles[newStatus]}`;
    }
}

// ë‹´ë‹¹ì ì§ì ‘ ë³€ê²½ í•¨ìˆ˜
function changeManagerDirect(index, newManager) {
    consultations[index].manager = newManager;
    autoSave();
}

// Edit Job Modal Functions
function openEditJobModal(index) {
    currentEditJobIndex = index;
    const consultation = consultations[index];
    document.getElementById('editJobSelect').value = consultation.job || '';
    document.getElementById('editJobModal').classList.remove('hidden');
    document.getElementById('editJobModal').classList.add('flex');
}

function closeEditJobModal() {
    document.getElementById('editJobModal').classList.add('hidden');
    document.getElementById('editJobModal').classList.remove('flex');
    currentEditJobIndex = -1;
}

function saveEditJob() {
    if (currentEditJobIndex === -1) return;

    const newJob = document.getElementById('editJobSelect').value;

    consultations[currentEditJobIndex].job = newJob;
    updateConsultationList();
    closeEditJobModal();
    autoSave();
    alert('ì§ì—…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// Edit Carrier Modal Functions
function openEditCarrierModal(index) {
    currentEditCarrierIndex = index;
    const consultation = consultations[index];
    document.getElementById('editCarrierSelect').value = consultation.carrier || '';
    document.getElementById('editCarrierModal').classList.remove('hidden');
    document.getElementById('editCarrierModal').classList.add('flex');
}

function closeEditCarrierModal() {
    document.getElementById('editCarrierModal').classList.add('hidden');
    document.getElementById('editCarrierModal').classList.remove('flex');
    currentEditCarrierIndex = -1;
}

function saveEditCarrier() {
    if (currentEditCarrierIndex === -1) return;

    const newCarrier = document.getElementById('editCarrierSelect').value;

    consultations[currentEditCarrierIndex].carrier = newCarrier;
    updateConsultationList();
    closeEditCarrierModal();
    autoSave();
    alert('í†µì‹ ì‚¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function openEditNameModal(index) {
    currentEditNameIndex = index;
    const consultation = consultations[index];
    document.getElementById('editNameInput').value = consultation.name;
    document.getElementById('editNameModal').classList.remove('hidden');
    document.getElementById('editNameModal').classList.add('flex');
}

function closeEditNameModal() {
    document.getElementById('editNameModal').classList.add('hidden');
    document.getElementById('editNameModal').classList.remove('flex');
    currentEditNameIndex = -1;
}

function saveEditName() {
    if (currentEditNameIndex === -1) return;

    const newName = document.getElementById('editNameInput').value.trim();
    if (!newName) {
        alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    consultations[currentEditNameIndex].name = newName;
    updateConsultationList();
    closeEditNameModal();
    autoSave();
    alert('ê³ ê°ëª…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// Edit Phone Modal Functions
function openEditPhoneModal(index) {
    currentEditPhoneIndex = index;
    const consultation = consultations[index];
    document.getElementById('editPhoneInput').value = consultation.phone;
    document.getElementById('editPhoneModal').classList.remove('hidden');
    document.getElementById('editPhoneModal').classList.add('flex');
}

function closeEditPhoneModal() {
    document.getElementById('editPhoneModal').classList.add('hidden');
    document.getElementById('editPhoneModal').classList.remove('flex');
    currentEditPhoneIndex = -1;
}

function saveEditPhone() {
    if (currentEditPhoneIndex === -1) return;

    const newPhone = document.getElementById('editPhoneInput').value.trim();
    if (!newPhone) {
        alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    consultations[currentEditPhoneIndex].phone = newPhone;
    updateConsultationList();
    closeEditPhoneModal();
    autoSave();
    alert('ì—°ë½ì²˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// Edit Birth Date Modal Functions
function openEditBirthModal(index) {
    currentEditBirthIndex = index;
    const consultation = consultations[index];
    document.getElementById('editBirthInput').value = consultation.birthDate || '';
    document.getElementById('editBirthModal').classList.remove('hidden');
    document.getElementById('editBirthModal').classList.add('flex');
}

function closeEditBirthModal() {
    document.getElementById('editBirthModal').classList.add('hidden');
    document.getElementById('editBirthModal').classList.remove('flex');
    currentEditBirthIndex = -1;
}

function saveEditBirth() {
    if (currentEditBirthIndex === -1) return;

    const newBirth = document.getElementById('editBirthInput').value.trim();

    consultations[currentEditBirthIndex].birthDate = newBirth;
    updateConsultationList();
    closeEditBirthModal();
    autoSave();
    alert('ìƒë…„ì›”ì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function toggleSelection(index) {
    if (selectedItems.has(index)) {
        selectedItems.delete(index);
    } else {
        selectedItems.add(index);
    }
    updateSelectionUI();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');

    if (selectAllCheckbox.checked) {
        const filteredConsultations = filterConsultations();

        filteredConsultations.forEach(consultation => {
            const globalIndex = consultations.findIndex(c => c.id === consultation.id);
            selectedItems.add(globalIndex);
        });

        const checkboxes = document.querySelectorAll('#consultationList input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = true);
    } else {
        selectedItems.clear();
        const checkboxes = document.querySelectorAll('#consultationList input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
    }

    updateSelectionUI();
}

function clearSelection() {
    selectedItems.clear();
    document.getElementById('selectAll').checked = false;
    const checkboxes = document.querySelectorAll('#consultationList input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateSelectionUI();
}

function updateSelectionUI() {
    const selectedCount = selectedItems.size;
    document.getElementById('selectedCount').textContent = selectedCount;

    const batchBtn = document.getElementById('batchStatusBtn');
    const deleteBtn = document.getElementById('batchDeleteBtn');

    if (selectedCount > 0) {
        batchBtn.disabled = false;
        batchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        deleteBtn.disabled = false;
        deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        batchBtn.disabled = true;
        batchBtn.classList.add('opacity-50', 'cursor-not-allowed');
        deleteBtn.disabled = true;
        deleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function updateStats() {
    const total = consultations.length;
    const progress = consultations.filter(c => c.status === 'ì§„í–‰ì¤‘').length;
    const approved = consultations.filter(c => c.status === 'â¤ï¸ìŠ¹ì¸ì™„ë£Œâ¤ï¸').length;

    document.getElementById('totalCount').textContent = total;
    document.getElementById('progressCount').textContent = progress;
    document.getElementById('approvedCount').textContent = approved;
}

function openMemoModal(index) {
    currentMemoIndex = index;
    const consultation = consultations[index];
    document.getElementById('memoCustomerName').textContent = consultation.name;
    document.getElementById('memoText').value = consultation.memo || '';
    document.getElementById('memoModal').classList.remove('hidden');
    document.getElementById('memoModal').classList.add('flex');
}

function closeMemoModal() {
    document.getElementById('memoModal').classList.add('hidden');
    document.getElementById('memoModal').classList.remove('flex');
    currentMemoIndex = -1;
}

function saveMemo() {
    if (currentMemoIndex === -1) return;

    const memoText = document.getElementById('memoText').value.trim();
    consultations[currentMemoIndex].memo = memoText;

    updateConsultationList();
    closeMemoModal();
    autoSave();

    alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function openStatusModal(index) {
    currentEditIndex = index;
    const consultation = consultations[index];
    document.getElementById('modalCustomerName').textContent = consultation.name;
    document.getElementById('currentStatus').textContent = consultation.status;
    document.getElementById('newStatus').value = consultation.status;
    document.getElementById('statusModal').classList.remove('hidden');
    document.getElementById('statusModal').classList.add('flex');
}

function closeModal() {
    document.getElementById('statusModal').classList.add('hidden');
    document.getElementById('statusModal').classList.remove('flex');
    currentEditIndex = -1;
}

function updateStatus() {
    if (currentEditIndex === -1) return;

    const newStatus = document.getElementById('newStatus').value;
    const oldStatus = consultations[currentEditIndex].status;

    if (newStatus === oldStatus) {
        alert('ë™ì¼í•œ ìƒíƒœì…ë‹ˆë‹¤.');
        return;
    }

    consultations[currentEditIndex].status = newStatus;

    updateConsultationList();
    updateStats();
    closeModal();
    autoSave();

    alert(`ìƒë‹´ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n${oldStatus} â†’ ${newStatus}`);
}

function openBatchStatusModal() {
    if (selectedItems.size === 0) return;

    document.getElementById('batchSelectedCount').textContent = `${selectedItems.size}ê°œ`;
    document.getElementById('batchStatusModal').classList.remove('hidden');
    document.getElementById('batchStatusModal').classList.add('flex');
}

function closeBatchModal() {
    document.getElementById('batchStatusModal').classList.add('hidden');
    document.getElementById('batchStatusModal').classList.remove('flex');
}

function updateBatchStatus() {
    const newStatus = document.getElementById('batchNewStatus').value;
    let changeCount = 0;

    selectedItems.forEach(index => {
        if (consultations[index].status !== newStatus) {
            consultations[index].status = newStatus;
            changeCount++;
        }
    });

    updateConsultationList();
    updateStats();
    clearSelection();
    closeBatchModal();
    autoSave();

    alert(`${changeCount}ê°œ í•­ëª©ì˜ ìƒíƒœê°€ "${newStatus}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function openBatchDeleteModal() {
    if (selectedItems.size === 0) return;

    document.getElementById('deleteSelectedCount').textContent = `${selectedItems.size}ê°œ`;
    document.getElementById('batchDeleteModal').classList.remove('hidden');
    document.getElementById('batchDeleteModal').classList.add('flex');
}

function closeBatchDeleteModal() {
    document.getElementById('batchDeleteModal').classList.add('hidden');
    document.getElementById('batchDeleteModal').classList.remove('flex');
}

function deleteBatchItems() {
    const selectedIndices = Array.from(selectedItems).sort((a, b) => b - a);
    let deleteCount = 0;

    selectedIndices.forEach(index => {
        consultations.splice(index, 1);
        deleteCount++;
    });

    selectedItems.clear();

    updateConsultationList();
    updateStats();
    updateSelectionUI();
    closeBatchDeleteModal();
    autoSave();

    alert(`${deleteCount}ê°œ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// Close modals when clicking outside
document.getElementById('statusModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.getElementById('batchStatusModal').addEventListener('click', function(e) {
    if (e.target === this) closeBatchModal();
});

document.getElementById('batchDeleteModal').addEventListener('click', function(e) {
    if (e.target === this) closeBatchDeleteModal();
});

document.getElementById('registrationModal').addEventListener('click', function(e) {
    if (e.target === this) closeRegistration();
});

document.getElementById('dataManagementModal').addEventListener('click', function(e) {
    if (e.target === this) closeDataManagement();
});

// Initialize selection UI
updateSelectionUI();
</script>
</body>
</html>
